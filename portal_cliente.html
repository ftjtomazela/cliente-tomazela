<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Faturas - Portal do Cliente</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom, #004e92 0%, #000428 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        .portal-nav {
            background: #111827;
            padding: 12px 20px;
            border-bottom: 2px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .portal-nav h2 {
            font-size: 1.2rem;
            color: #fff;
        }
        .nav-btn {
            background: #374151; color: #f3f4f6; border: none;
            padding: 10px 15px; border-radius: 8px; font-weight: bold;
            font-size: 0.9rem; cursor: pointer; text-decoration: none; 
            transition: all 0.3s;
        }
        .nav-btn.logout { background: #dc2626; color: #fff; }
        .nav-btn.logout:hover { background: #ef4444; }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
        }
        .header { text-align: left; margin-bottom: 30px; }
        .header h1 { font-size: 2.2rem; color: #fff; }
        .header p { font-size: 1.1rem; color: #9ca3af; }

        .fatura-card {
            background: linear-gradient(145deg, #2d3748, #1a202c);
            border: 2px solid #374151;
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        .fatura-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .fatura-header:hover { background: #374151; }
        .fatura-info .data { font-size: 1.2rem; font-weight: bold; }
        .fatura-info .status {
            font-size: 0.9rem; font-weight: bold;
            padding: 4px 8px; border-radius: 6px;
            margin-top: 5px; display: inline-block;
        }
        /* Cor Laranja para Pendente */
        .status-pendente { background: #f59e0b; color: #fff; }
        /* Cor Verde para Pago */
        .status-pago { background: #10b981; color: #fff; }
        
        .fatura-valor {
            text-align: right;
        }
        .fatura-valor .total { font-size: 1.5rem; font-weight: bold; }
        .fatura-valor .ver-detalhes { font-size: 0.9rem; color: #007bff; }

        .fatura-detalhes {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .fatura-detalhes-content {
            padding: 20px;
            border-top: 1px dashed #4b5563;
            background: #1a202c;
        }
        
        .nota-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 1rem;
            border-bottom: 1px solid #374151;
        }
        .nota-item .nome { color: #ccc; }
        .nota-item .valor { font-weight: 500; }
        .nota-total {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #fff;
        }

        .pix-section {
            background: #f4f4f4;
            color: #000;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .pix-section h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }
        .pix-section p {
            font-size: 1rem;
            color: #333;
            margin-bottom: 15px;
        }
        .pix-chave {
            background: #fff;
            border: 2px dashed #007bff;
            padding: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            color: #000;
            word-wrap: break-word;
        }
        .btn-copiar-pix {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 15px;
        }

        .visita-detalhes-content {
            padding: 20px;
            border-top: 1px dashed #4b5563;
            background: #1a202c;
        }
        .visita-detalhes-content h4 {
            font-size: 1.1rem;
            color: #007bff;
            margin-bottom: 10px;
        }
        .visita-detalhes-content p {
            font-size: 1rem;
            color: #ccc;
            margin-bottom: 5px;
            white-space: pre-wrap; 
            word-break: break-word;
        }
        .visita-detalhes-content p strong {
            color: #fff;
            min-width: 120px;
            display: inline-block;
        }
        .visita-detalhes-content ul {
            list-style: none;
            padding-left: 20px;
        }
        .visita-detalhes-content li {
            color: #ccc;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>

    <div class="portal-nav">
        <h2>Portal do Cliente</h2>
        <button id="logout-btn" class="nav-btn logout">Sair</button>
    </div>

    <div class="container">
        <div class="header">
            <h1 id="welcome-message">Carregando...</h1>
            <p>Abaixo estão suas faturas e visitas. Clique para ver os detalhes.</p>
        </div>

        <div id="faturas-pendentes">
            <h2>Faturas Pendentes</h2>
            <div id="lista-pendentes"></div>
        </div>
        
        <hr style="border: 1px solid #374151; margin: 30px 0;">

        <div id="faturas-historico">
            <h2>Histórico de Faturas</h2>
            <div id="lista-historico"></div>
        </div>

        <hr style="border: 1px solid #374151; margin: 30px 0;">
        <div id="visitas-historico">
            <h2>Histórico de Visitas</h2>
            <div id="lista-visitas">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
        import { 
            getDatabase, ref, get, query, orderByChild, equalTo 
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_2Ssx3a3CW3PEP2RBh7j5TQl1UPuSg4k",
            authDomain: "tomazela-piscinas.firebaseapp.com",
            databaseURL: "https://tomazela-piscinas-default-rtdb.firebaseio.com", 
            projectId: "tomazela-piscinas",
            storageBucket: "tomazela-piscinas.firebasestorage.app",
            messagingSenderId: "776818671387",
            appId: "1:776818671387:web:ca4211e6fa8f3f1c889dbe",
            measurementId: "G-PP230KYC4X"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        const clientesRef = ref(database, 'clientes');
        const faturasRef = ref(database, 'faturas'); // Leitura do NÓ PRINCIPAL
        const empresaRef = ref(database, 'empresa');
        const visitasRef = ref(database, 'visitas'); 
        
        let dadosEmpresa = {};

        // Função "Tradutor" de Data DD/MM/AAAA
        function parsePtBrDate(dateString) {
            if (!dateString || dateString.split('/').length !== 3) {
                return new Date(); 
            }
            const parts = dateString.split('/'); 
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        // --- Autenticação ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadPortalData(user.email);
            } else {
                window.location.href = 'login_cliente.html';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        // --- Carregamento dos Dados ---
        async function loadPortalData(userEmail) {
            try {
                // 1. Busca os dados da EMPRESA (para o PIX)
                const empresaSnap = await get(empresaRef);
                if (empresaSnap.exists()) {
                    dadosEmpresa = empresaSnap.val();
                }

                // 2. Busca o ID do CLIENTE usando o email de login
                const clienteQuery = query(clientesRef, orderByChild('emailAcesso'), equalTo(userEmail));
                const clienteSnap = await get(clienteQuery);
                
                if (!clienteSnap.exists()) {
                    document.getElementById('welcome-message').textContent = 'Erro: Cliente não encontrado.';
                    return;
                }
                
                let clienteData = {};
                clienteSnap.forEach(child => { 
                    clienteData = { id: child.key, ...child.val() };
                });
                
                document.getElementById('welcome-message').textContent = `Bem-vindo, ${clienteData.nome}!`;

                // 3. Busca as FATURAS desse cliente (Lendo do NÓ PRINCIPAL /faturas)
                const faturasQuery = query(faturasRef, orderByChild('cliente/id'), equalTo(clienteData.id));
                const faturasSnap = await get(faturasQuery);
                
                let faturasList = [];
                if (faturasSnap.exists()) {
                    faturasSnap.forEach(child => {
                        faturasList.push({ id: child.key, ...child.val() });
                    });
                    faturasList.sort((a, b) => new Date(b.dataFechamento) - new Date(a.dataFechamento));
                }
                renderFaturas(faturasList);
                
                // 4. Busca as VISITAS desse cliente
                const visitasQuery = query(visitasRef, orderByChild('clienteId'), equalTo(clienteData.id));
                const visitasSnap = await get(visitasQuery);
                
                let visitasList = [];
                if (visitasSnap.exists()) {
                    visitasSnap.forEach(child => {
                        visitasList.push({ id: child.key, ...child.val() });
                    });
                    
                    visitasList.sort((a, b) => parsePtBrDate(b.data) - parsePtBrDate(a.data));
                }
                
                renderVisitas(visitasList); 
                
            } catch (error) {
                console.error("Erro ao carregar dados do portal:", error);
                if (error.message.includes("index")) {
                     document.getElementById('lista-visitas').innerHTML = `<p style="color:red;"><b>Erro de Admin:</b> Falta o índice '.indexOn' para 'clienteId' nas regras do 'visitas' no Firebase.</p>`;
                } else {
                     document.getElementById('welcome-message').textContent = 'Erro ao carregar dados.';
                }
            }
        }

        // --- Renderização das Faturas (Separa Pendentes e Pagos) ---
        function renderFaturas(faturasList) {
            const pendentesContainer = document.getElementById('lista-pendentes');
            const historicoContainer = document.getElementById('lista-historico');
            
            pendentesContainer.innerHTML = '';
            historicoContainer.innerHTML = '';
            
            let pendentesCount = 0;
            let historicoCount = 0;

            faturasList.forEach(fatura => {
                // Lê o status do nó principal
                if (fatura.status === 'Pago') {
                    historicoCount++;
                    historicoContainer.appendChild(createFaturaCard(fatura));
                } else {
                    // Trata 'Pendente' e faturas antigas sem status como 'Pendente'
                    pendentesCount++;
                    pendentesContainer.appendChild(createFaturaCard(fatura));
                }
            });

            if (pendentesCount === 0) {
                pendentesContainer.innerHTML = '<p>Nenhuma fatura pendente.</p>';
            }
            if (historicoCount === 0) {
                historicoContainer.innerHTML = '<p>Nenhum histórico de faturas pagas.</p>';
            }
        }
        
        function createFaturaCard(fatura) {
            const data = new Date(fatura.dataFechamento);
            const mesAno = data.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            
            const card = document.createElement('div');
            card.className = 'fatura-card';
            
            let statusHtml = '';
            let pixHtml = ''; 

            // Lógica do Status e PIX
            if (fatura.status === 'Pago') {
                statusHtml = '<span class="fatura-info status status-pago">PAGO</span>';
            } else {
                statusHtml = '<span class="fatura-info status status-pendente">PENDENTE</span>';
                // Se estiver pendente, mostra a seção PIX
                pixHtml = `
                    <div class="pix-section">
                        <h3>Pague sua Fatura</h3>
                        <p>Use a chave PIX (CNPJ) abaixo para pagar o valor total de <strong>R$ ${fatura.totalFatura.toFixed(2)}</strong> e envie o comprovante.</p>
                        <div class="pix-chave">${dadosEmpresa.cnpj || 'CNPJ não cadastrado'}</div>
                        <button class="btn-copiar-pix" data-cnpj="${dadosEmpresa.cnpj || ''}">Copiar Chave PIX</button>
                    </div>
                `;
            }

            // Renderiza os itens (a "nota")
            let itensHtml = '';
            itensHtml += `
                <div class="nota-item">
                    <span class="nome">Mensalidade Base</span>
                    <span class="valor">R$ ${fatura.mensalidadeBase.toFixed(2)}</span>
                </div>
            `;
            
            if (fatura.itensFaturados && fatura.itensFaturados.length > 0) {
                fatura.itensFaturados.forEach(servico => {
                    servico.itens.forEach(item => {
                        itensHtml += `
                            <div class="nota-item">
                                <span class="nome">${item.quantidade}x ${item.nome}</span>
                                <span class="valor">R$ ${(item.precoTotal * item.quantidade).toFixed(2)}</span>
                            </div>
                        `;
                    });
                });
            }

            // Monta o card
            card.innerHTML = `
                <div class="fatura-header" onclick="toggleDetalhes(this)">
                    <div class="fatura-info">
                        <div class="data">Fatura de ${mesAno}</div>
                        ${statusHtml}
                    </div>
                    <div class="fatura-valor">
                        <div class="total">R$ ${fatura.totalFatura.toFixed(2)}</div>
                        <span class="ver-detalhes">Ver detalhes </span>
                    </div>
                </div>
                <div class="fatura-detalhes">
                    <div class="fatura-detalhes-content">
                        <h4>Itens da Fatura (Nota)</h4>
                        ${itensHtml}
                        <div class="nota-total">
                            <span>TOTAL</span>
                            <span>R$ ${fatura.totalFatura.toFixed(2)}</span>
                        </div>
                        
                        ${pixHtml} </div>
                </div>
            `;
            
            // Adiciona a função de "Copiar" no botão (só se o botão existir)
            const btnCopiar = card.querySelector('.btn-copiar-pix');
            if (btnCopiar) {
                btnCopiar.addEventListener('click', (e) => {
                    const cnpj = e.target.dataset.cnpj;
                    navigator.clipboard.writeText(cnpj).then(() => {
                        e.target.textContent = 'Copiado!';
                        setTimeout(() => { e.target.textContent = 'Copiar Chave PIX'; }, 2000);
                    }).catch(err => {
                        alert('Erro ao copiar CNPJ.');
                    });
                });
            }

            return card;
        }

        // --- Funções para Renderizar Visitas ---
        function renderVisitas(visitasList) {
            const container = document.getElementById('lista-visitas');
            container.innerHTML = ''; 

            if (visitasList.length === 0) {
                container.innerHTML = '<p>Nenhum histórico de visita encontrado.</p>';
                return;
            }
            
            visitasList.forEach(visita => {
                container.appendChild(createVisitaCard(visita));
            });
        }
        
        function createVisitaCard(visita) {
            const data = parsePtBrDate(visita.data); 
            const dataFormatada = data.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
            
            const card = document.createElement('div');
            card.className = 'fatura-card'; 

            card.innerHTML = `
                <div class="fatura-header" onclick="toggleDetalhes(this)">
                    <div class="fatura-info">
                        <div class="data">Visita de ${dataFormatada}</div>
                    </div>
                    <div class="fatura-valor">
                        <span class="ver-detalhes">Ver medições </span>
                    </div>
                </div>
                <div class="fatura-detalhes"> 
                    <div class="visita-detalhes-content">
                        <h4>Medições</h4>
                        <p><strong>PH:</strong> ${visita.ph || 'N/A'}</p>
                        <p><strong>Cloro (CL):</strong> ${visita.cloro || 'N/A'}</p>
                        <p><strong>Alcalinidade (ALK):</strong> ${visita.alcalinidade || 'N/A'}</p>
                        
                        <h4 style="margin-top: 15px;">Observações</h4>
                        <p>${visita.observacoes || 'Nenhuma observação.'}</p>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Função para expandir/recolher (Funciona para Faturas e Visitas)
        window.toggleDetalhes = (headerElement) => {
            const detalhes = headerElement.nextElementSibling;
            if (detalhes.style.maxHeight) {
                detalhes.style.maxHeight = null;
            } else {
                detalhes.style.maxHeight = (detalhes.scrollHeight + 20) + "px";
            }
        }

    </script>
</body>
</html>
